require(["jquery","ajs","confluence/setup/setup-tracker","confluence/setup/utils"],function(h,l,b,w){l.$.ajaxSetup({timeout:30000});h(function(){B()&&h("h1").append("<small style='display: block'> dev mode active: running against lasso/hamlet staging servers. feel free to create accounts and generate keys with fake data</small>")});var c=_.once(function(){return"withCredentials" in new XMLHttpRequest()});function B(){return w.getMeta("dev-mode")}function q(){return B()?"https://id.stg.internal.atlassian.com/":"https://id.atlassian.com/"}function p(){return B()?"https://hamlet.stg.intsys.atlassian.com/":"https://hamlet.atlassian.com/"}var e=function(C){return unescape(encodeURIComponent(C))};var o=function(H){var G="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";var I=e(JSON.stringify(H))+"  ";var C=[];for(var F=0;F+2<I.length;F+=3){var J=0;for(var E=0;E<3;++E){J=(J<<8)+I.charCodeAt(F+E)}for(var E=3;E>=0;--E){var D=(J>>(6*E))&63;C.push(G.charAt(D))}}return C.join("")};var y=function(D){var E={};var C=D.serializeArray();l.$.each(C,function(){if(E[this.name]!==undefined){if(!E[this.name].push){E[this.name]=[E[this.name]]}E[this.name].push(this.value||"")}else{E[this.name]=this.value||""}});return E};function s(D){var C=_.pick(D,"username","password");if(c()){return l.$.ajax({url:q()+"id/rest/login",type:"POST",contentType:"application/json",dataType:"json",xhrFields:{withCredentials:true},data:JSON.stringify(C)})}else{return l.$.ajax({url:q()+"id/rest/login",type:"POST",contentType:"application/json",dataType:"jsonp",jsonp:"jsonp",data:{method:"POST","h-Content-Type":"application/json",body:o(C)}}).pipe(function(F,G){var E={};E.status=F[0].status||F.status;E.message=F[0].message||F.message;E.responseText=JSON.stringify(F[1])||"";if(E.status!=200){return(jQuery.Deferred().rejectWith(F,[E,G]))}else{E.username=F[1].username;E.xsrfToken=F[1].xsrfToken;return(jQuery.Deferred().resolveWith(F,[E,G]))}})}}function d(C){if(_.has(C,"subscribeNewsletter")){C.subscribeNewsletter="true"}if(c()){return l.$.ajax({url:q()+"profile/rest/signUp",type:"POST",contentType:"application/json",dataType:"json",xhrFields:{withCredentials:true},data:JSON.stringify(C)})}else{return l.$.ajax({url:q()+"profile/rest/signUp",type:"GET",contentType:"application/json",dataType:"jsonp",jsonp:"jsonp",data:{method:"POST","h-Content-Type":"application/json",body:o(C)}}).pipe(function(E,F){var D={};D.status=E[0].status||E.status;D.message=E[0].message||E.message;D.responseText=JSON.stringify(E[1])||"";if(D.status!=200){return(jQuery.Deferred().rejectWith(E,[D,F]))}else{D.username=E[1].username;D.xsrfToken=E[1].xsrfToken;return(jQuery.Deferred().resolveWith(E,[D,F]))}})}}function u(C,E){if(C.status===403){var D=JSON.parse(C.responseText);if(!_.isUndefined(D)){k(l.I18n.getText("setup.evallicense.loginmac.error.signin"),D.error)}else{k(l.I18n.getText("setup.evallicense.error.unknown.title"),l.I18n.getText("setup.evallicense.error.unknown.desc"))}}else{z(C,E)}}function n(D,F){if(D.status===400){var E=JSON.parse(D.responseText);var C=E.fieldErrors;if(C&&!h.isEmptyObject(C)){_.each(C,function(G,H){j(H,G)})}else{k(l.I18n.getText("setup.evallicense.error.unknown.title"),l.I18n.getText("setup.evallicense.error.unknown.desc"));if(E.unknownError){k(null,E.unknownError)}}}else{z(D,F)}}function z(C,D){if(C.status===500){k(l.I18n.getText("setup.evallicense.error.internalserver.title"),l.I18n.getText("setup.evallicense.error.internalserver.desc"))}else{if(C.status===404){k(l.I18n.getText("setup.evallicense.error.notfound.title"),l.I18n.getText("setup.evallicense.error.notfound.desc"))}else{if(C.status===0){k(l.I18n.getText("setup.evallicense.error.noconnection.title"),l.I18n.getText("setup.evallicense.error.noconnection.desc"))}else{if(D=="timeout"){k(l.I18n.getText("setup.evallicense.error.timeout.title"),l.I18n.getText("setup.evallicense.error.timeout.desc"))}else{k(l.I18n.getText("setup.evallicense.error.unknown.title"),l.I18n.getText("setup.evallicense.error.unknown.desc"))}}}}}function j(D,C){h("<div>").attr({id:D+"-error","class":"error"}).text(C).insertAfter(h("#"+D))}function k(E,C){var D=i();l.messages.error(D.find(".form-error"),{title:E,body:C,closeable:false})}function f(){l.$('input:[name="license-selector"]').attr("disabled","disabled")}function m(){l.$('input:[name="agree-checkbox"]').attr("disabled","disabled")}function t(){l.$('input:[name="license-selector"]').removeAttr("disabled")}function v(){l.$('input:[name="agree-checkbox"]').removeAttr("disabled")}function A(){l.$(".error").remove()}function i(){return h(".license-form:visible").first()}function x(){h(":submit").removeAttr("disabled");l.$('input[name="agree-checkbox"]').trigger("change");h(".loading-spinner").remove();t();v()}function r(D){var C={productKey:"confluence",serverId:w.getMeta("server-id")};if(c()){return l.$.ajax({url:p()+"1.0/public/license/createEvaluation",type:"POST",beforeSend:function(E){E.setRequestHeader("ATL-XSRF-Token",D)},xhrFields:{withCredentials:true},contentType:"application/json",dataType:"json",data:JSON.stringify(C)})}else{return l.$.ajax({url:p()+"1.0/public/license/createEvaluation",type:"GET",contentType:"application/json",dataType:"jsonp",jsonp:"jsonp",data:{method:"POST","h-Content-Type":"application/json","h-ATL-XSRF-Token":D,body:o(C)}}).pipe(function(F,G){var E={};E.status=F[0].status||F.status;E.message=F[0].message||F.message;E.responseText=JSON.stringify(F[1])||"";if(E.status!=200){return(jQuery.Deferred().rejectWith(F,[E,G]))}else{E.licenseKey=F[1].licenseKey;E.id=F[1].id;return(jQuery.Deferred().resolveWith(F,[E,G]))}})}}function a(C){h("#licenseString").val(C);h("#importLicenseForm").submit()}function g(F,C){var E=h("#loading-spinner-template").html();var D=_.template(E,{message:F});C.find(":submit").after(D)}h(function(){h("input[name=license-selector]").change(function(){var C=h(this).val();h(".license-form").hide();h("#"+C).show()});h("#newAccountForm").submit(function(E){E.preventDefault();b.insert("newaccount");A();f();m();g(l.I18n.getText("setup.evallicense.newaccount.loading"),h(this));var D=y(l.$(E.target));var C=d(D);C.fail(n,x);C.done(function(G){var F=r(G.xsrfToken);F.fail(z,x);F.done(function(I){var H=I.licenseKey;a(H)})})});h("#loginMacForm").submit(function(E){E.preventDefault();b.insert("haveaccount");A();f();m();g(l.I18n.getText("setup.evallicense.loginmac.loading"),h(this));var D=y(l.$(E.target));var C=s(D);C.fail(u,x);C.done(function(G){var F=r(G.xsrfToken);F.fail(z,x);F.done(function(I){var H=I.licenseKey;a(H)})})});h("#importLicenseForm").submit(function(){b.insert("havekey");A();f();g(l.I18n.getText("setup.evallicense.importlicense.loading"),h(this))});l.$('input[name="agree-checkbox"]').change(function(){var D=this.value;var C=l.$("#"+D).find('input[class="aui-button aui-button-primary"]');if(this.checked){C.removeAttr("disabled")}else{C.attr("disabled","disabled")}})})});